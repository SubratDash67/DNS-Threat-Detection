# PostgreSQL Migration Guide for Render Deployment

This guide will help you migrate from SQLite to PostgreSQL to fix authentication, safelist, and profile statistics issues.

## üéØ Issues Fixed by This Migration

1. **Profile Stats Showing Wrong Values** - Database persistence ensures accurate statistics
2. **Authentication Breaking After Backend Sleep** - PostgreSQL data survives Render restarts
3. **Safelist Domains Disappearing** - Persistent storage for all safelist entries

---

## üìã Prerequisites

- GitHub account with your repository pushed
- Render account (free tier works)
- Vercel account for frontend (if using)

---

## üöÄ Step-by-Step Deployment

### **Step 1: Update Your Render Backend Service**

Since you've already pushed the updated code to GitHub, Render will automatically pick up the changes when you redeploy.

#### Option A: Using render.yaml (Recommended - Automatic Setup)

1. **Go to Render Dashboard**: https://dashboard.render.com/
2. **Create New PostgreSQL Database**:
   - Click "New +" ‚Üí "PostgreSQL"
   - Name: `dns-threat-detector-db`
   - Database Name: `dns_security`
   - Region: Same as your backend (e.g., Oregon)
   - Plan: **Free**
   - Click "Create Database"

3. **Update Your Backend Service**:
   - Go to your existing web service (`dns-threat-detector-api`)
   - Go to "Settings" ‚Üí "Environment"
   - **Delete** the old `DATABASE_URL` if it exists
   - Click "Add Environment Variable"
   - Key: `DATABASE_URL`
   - Value: Click "From Database" ‚Üí Select `dns-threat-detector-db` ‚Üí `Internal Database URL`
   - Click "Save Changes"

4. **Update Build Command**:
   - Go to "Settings" ‚Üí "Build & Deploy"
   - Build Command: `pip install -r requirements.txt && alembic upgrade head`
   - Root Directory: `backend`
   - Click "Save Changes"

5. **Trigger Manual Deploy**:
   - Go to "Manual Deploy" ‚Üí "Deploy latest commit"

#### Option B: Manual Setup (If render.yaml doesn't auto-deploy)

1. **Create PostgreSQL Database** (same as Option A, steps 2)

2. **Update Backend Service Environment Variables**:
   ```
   ENV=production
   DEBUG=false
   DATABASE_URL=<from database connection string>
   SECRET_KEY=<auto-generated or your secret>
   ALLOWED_ORIGINS=https://your-vercel-app.vercel.app
   MAX_BATCH_SIZE=10000
   BATCH_CHUNK_SIZE=100
   ```

3. **Important**: Make sure `DATABASE_URL` uses the **Internal Database URL** from your PostgreSQL database, which should look like:
   ```
   postgresql://username:password@hostname:port/database
   ```

4. The system will automatically convert this to:
   ```
   postgresql+asyncpg://username:password@hostname:port/database
   ```

### **Step 2: Verify Database Migration**

1. **Check Deployment Logs**:
   - Go to your backend service
   - Click "Logs"
   - Look for: `Running upgrade -> head` (Alembic migrations)
   - Should see: `SUCCESS` messages

2. **Test API Health**:
   ```
   https://your-backend-url.onrender.com/health
   ```
   Should return: `{"status": "healthy"}`

3. **Check Database Tables**:
   - Go to your PostgreSQL database on Render
   - Click "Connect" ‚Üí Use the Web Shell
   - Run:
     ```sql
     \dt
     ```
   - You should see tables: `users`, `scans`, `batch_jobs`, `safelist_domains`, `reports`, `activity_logs`

### **Step 3: Update Frontend Environment Variables**

1. **Go to Vercel Dashboard**: https://vercel.com/dashboard
2. **Select Your Project**
3. **Settings** ‚Üí **Environment Variables**
4. **Update/Add**:
   ```
   VITE_API_BASE_URL=https://your-backend-url.onrender.com
   ```
5. **Redeploy** your frontend

### **Step 4: Test the Application**

1. **Sign Up a New User**:
   - Go to your frontend URL
   - Register a new account
   - This will create the user in PostgreSQL

2. **Test Profile Page**:
   - Log in
   - Navigate to Profile
   - Stats should show `0` for all metrics (correct for new user)
   - Not the old hardcoded `1247` scans

3. **Test Safelist**:
   - Add a domain to safelist (e.g., `google.com`, Tier 1)
   - Refresh the page
   - Domain should persist

4. **Test Authentication Persistence**:
   - Wait 15+ minutes (Render free tier sleeps after inactivity)
   - Visit the site again
   - Your login session should work
   - Your data should still be there

### **Step 5: Populate Initial Safelist (Optional)**

If you want to add initial safelist domains:

```bash
# SSH into your Render service or use Render Shell
cd backend
python populate_safelist_async.py
```

Or use the frontend's safelist management page to manually add domains.

---

## üîç Troubleshooting

### Issue: "Connection to server failed"
**Solution**: 
- Ensure `DATABASE_URL` uses the **Internal Database URL** (not External)
- Format should be: `postgresql://...` (Render auto-adds `+asyncpg`)

### Issue: "relation 'users' does not exist"
**Solution**:
- Migrations didn't run
- Manually run: `alembic upgrade head` in Render Shell
- Or add to Build Command: `pip install -r requirements.txt && alembic upgrade head`

### Issue: Frontend shows "Network Error"
**Solution**:
- Update `ALLOWED_ORIGINS` in backend to include your Vercel URL
- Check Vercel environment variable `VITE_API_BASE_URL` points to Render backend

### Issue: "SSL connection required"
**Solution**:
- Render PostgreSQL requires SSL
- The code already handles this with `pool_pre_ping=True`
- No action needed

### Issue: Still showing old stats (1247 scans)
**Solution**:
- Clear browser cache
- Hard refresh (Ctrl+Shift+R or Cmd+Shift+R)
- Check browser console for API errors
- Verify `/api/users/statistics` endpoint is working

---

## üìä Verifying the Fix

### Before Migration (SQLite Issues):
- ‚ùå Profile shows 1247 scans for everyone
- ‚ùå Login expires after backend sleep
- ‚ùå Safelist domains disappear

### After Migration (PostgreSQL):
- ‚úÖ Profile shows **accurate** stats per user
- ‚úÖ Login persists across backend restarts
- ‚úÖ Safelist domains are **permanently stored**

---

## üéâ Success Checklist

- [ ] PostgreSQL database created on Render
- [ ] Backend service uses PostgreSQL `DATABASE_URL`
- [ ] Build command includes `alembic upgrade head`
- [ ] Database migrations ran successfully
- [ ] Frontend points to correct backend URL
- [ ] Can register new user
- [ ] Profile shows correct stats (0 for new user)
- [ ] Safelist domains persist after refresh
- [ ] Authentication works after backend sleep/wake

---

## üìù Notes

- **Free Tier Limits**: 
  - Render PostgreSQL Free: 1 GB storage, 100 MB RAM
  - Render Web Service Free: Sleeps after 15 min inactivity
  - Data PERSISTS in PostgreSQL even when backend sleeps

- **Database URL Format**:
  - Render provides: `postgresql://user:pass@host:port/db`
  - Code converts to: `postgresql+asyncpg://user:pass@host:port/db`
  - Alembic uses: `postgresql://user:pass@host:port/db` (sync driver)

- **Local Development**:
  - Still uses SQLite: `sqlite+aiosqlite:///./dns_security.db`
  - No changes needed to `.env` file for local testing

---

## üîó Useful Commands

### Check Database Connection (Render Shell)
```bash
python -c "from app.core.database import engine; print(engine.url)"
```

### Run Migrations Manually
```bash
alembic upgrade head
```

### Check Current Migration Version
```bash
alembic current
```

### Create Admin User (Render Shell)
```python
import asyncio
from app.core.database import AsyncSessionLocal
from app.models.user import User
from app.core.security import get_password_hash

async def create_admin():
    async with AsyncSessionLocal() as db:
        admin = User(
            email="admin@example.com",
            hashed_password=get_password_hash("ChangeMe123!"),
            full_name="Admin User",
            role="admin",
            is_active=True
        )
        db.add(admin)
        await db.commit()
        print("Admin user created!")

asyncio.run(create_admin())
```

---

## üÜò Support

If you encounter issues:
1. Check Render logs: Service ‚Üí Logs
2. Check browser console for frontend errors
3. Verify environment variables are set correctly
4. Ensure database URL uses Internal URL, not External

---

**Last Updated**: November 7, 2025
**Version**: 1.0.0
